generator_guideline='''
1. **Sudden, painless, severe complete loss of vision**
   - Vision disappeared completely without any pain.
   - Everything went black suddenly and painlessly.
   - Lost vision instantly without discomfort.
   - Vision vanished abruptly, no pain involved.
   - Sight was gone all at once, no pain felt.

2. **Loss of vision after surgery or procedure**
   - Vision faded away after the operation.
   - Couldn't see anything post-surgery.
   - Experienced blindness following the procedure.
   - Sight was lost shortly after surgery.
   - Vision disappeared soon after the procedure.

3. **Curtain effect vision loss**
   - Felt like a curtain dropped over the eyes.
   - Vision was suddenly blocked as if by a drape.
   - A shadow fell over sight like a veil.
   - Seemed like a blind was pulled over vision.
   - Vision went dark from the top down, like a curtain.

4. **New partial vision loss or area of complete loss**
   - Suddenly couldn't see part of the field of view.
   - A new blind spot appeared in vision.
   - Part of sight has gone missing.
   - Experienced a sudden patch of vision loss.
   - Noticed a new area where vision is absent.

5. **Subacute loss of vision evolving over a few days to a week (persistent or intermittent)**
   - Vision has been gradually fading over several days.
   - Sight has been coming and going over the week.
   - Slowly losing vision day by day.
   - Vision has intermittently worsened over a week.
   - Sight has been diminishing gradually over days.

6. **Transient loss of vision**
   - Vision went out temporarily but returned.
   - Had a brief episode of blindness.
   - Sight was lost for a short moment.
   - Experienced a temporary blackout in vision.
   - Vision disappeared briefly and came back.

7. **Vision changes after surgery or procedure**
   - Vision altered following the surgery.
   - Noticed changes in sight after the procedure.
   - Vision was different post-operation.
   - Experienced vision shifts after surgery.
   - Sight was altered following the procedure.

8. **Sudden onset of diplopia (double vision)**
   - Started seeing double all of a sudden.
   - Vision split into two images instantly.
   - Suddenly everything appears doubled.
   - Experienced immediate double vision.
   - Objects suddenly appear duplicated.

9. **Sudden onset of distorted vision, spot of blurring, or missing area**
   - Vision became warped all of a sudden.
   - A blurred spot appeared in sight instantly.
   - Noticed a missing patch in vision suddenly.
   - Experienced immediate distortion in sight.

10. **Sudden or gradual blurred vision in a specific area**
    - Blurriness developed quickly in one spot.
    - Vision became hazy in a specific area over time.
    - Noticed a gradual blur in one part of sight.
    - A sudden blur appeared in a particular spot.
    - Vision gradually blurred in one region.

11. **Difficulty with near or distance work, fine or print**
    - Struggling to focus on close tasks.
    - Having trouble seeing far away.
    - Difficulty reading fine print.
    - Finding it hard to see things up close.
    - Can't focus well on distant objects.

12. **Blurry vision only at distance or only at near in patients in their late 30s or 40s (improves with blinking or eye drops)**
    - Distance vision blurs but clears with blinking.
    - Near vision is fuzzy but eye drops help.
    - Blurriness at far distances, resolves with blinking.
    - Close-up vision is unclear, better with drops.
    - Blurry vision at near, improves with blinking.

13. **Acute, rapid onset of eye pain or discomfort**
    - Eye pain started suddenly and intensely.
    - Felt sharp discomfort in eye all at once.
    - Experienced immediate eye pain.
    - Rapid onset of discomfort in the eye.
    - Eye pain hit suddenly.

14. **Acute eye pain with nausea and foggy vision**
    - Sharp eye pain accompanied by nausea.
    - Felt nauseous with eye pain and cloudy sight.
    - Eye pain with queasiness and blurry vision.
    - Nausea and foggy vision alongside eye pain.
    - Eye hurt severely with nausea and haze.

15. **Progressively worsening ocular pain**
    - Eye pain has been getting worse over time.
    - Pain in the eye is becoming more severe.
    - Eye hurts more and more each day.

16. **Worsening pain after surgery or procedure**
    - Pain increased following the operation.
    - Discomfort worsened after the procedure.
    - Experienced more pain post-surgery.
    - Pain intensified after the procedure.
    - Post-surgery pain has been getting worse.

17. **Mild ocular pain accompanied by redness and/or decrease in vision**
    - Eye feels slightly painful with redness.
    - Mild pain with some vision loss and redness.
    - Eye is red and slightly sore.
    - Vision has decreased with mild eye pain.
    - Red eye with a bit of discomfort.

18. **Discomfort after prolonged use of the eyes**
    - Eyes feel strained after long use.
    - Vision gets uncomfortable after lengthy use.
    - Feel eye fatigue after using them for a while.
    - Eyes hurt after prolonged concentration.

19. **Recent onset of light flashes and floaters in patients with myopia**
    - New floaters and flashes in nearsighted vision.
    - Myopic vision now has light flashes.
    - New visual disturbances with myopia.

20. **Recent onset of light flashes and floaters after surgery or procedure**
    - Flashes and floaters appeared post-surgery.
    - Noticed light flashes after the procedure.
    - Floaters began after the operation.
    - Experienced visual flashes post-procedure.
    - New floaters and flashes following surgery.

21. **Recent onset of light flashes and floaters accompanied by shadows in peripheral vision**
    - Flashes and floaters with side shadows.
    - Floaters and peripheral shadows appeared.
    - Flashes with shadows in side vision.
    - Peripheral vision has shadows with floaters.

22. **Recent onset of light flashes and floaters without emergent conditions**
    - Sparks of light.
    - Tiny shadows or spots drifting in vision.
    - Little specks are floating around eyes.
    - Seeing brief flashes, like a camera flash.
    - Something is moving across sight.

23. **Persistent and unchanged floaters with previously determined cause**
    - Constant floaters, cause already known.
    - Floaters remain the same, reason identified.
    - Known cause for unchanging floaters.
    - Floaters persist, but cause is understood.
    - Unchanged floaters with a known source.

24. **Worsening redness or discharge after surgery or procedure**
    - Getting redder since the surgery.
    - More fluid leaking from eyes after the procedure.

25. **Redness or discharge in a contact lens wearer**
    - Contact lenses causing eye redness.
    - Discharge appeared with contact use.
    - Red eyes while wearing contacts.
    - Lenses lead to eye discharge.

26. **Acute redness with nausea and foggy vision**
    - Sudden red eye with nausea and blur.
    - Felt sick with red eyes and cloudy vision.
    - Red eyes, nausea, and foggy sight together.
    - Nauseous with red, blurry eyes.
    - Eyes turned red, felt queasy, and sight was hazy.

27. **Acute red eye, with or without discharge**
    - Suddenly got a red eye, maybe some irritation.
    - Red eye appeared quickly, without discharge.

28. **Acute red eye with pain**
    - Red eye started suddenly with pain.
    - Eye turned red and painful quickly.
    - Experienced immediate red, painful eye.
    - Sudden onset of eye redness with pain.
    - Painful red eye appeared abruptly.

29. **Discharge or tearing causing eyelids to stick together**
    - Eyes stuck shut from discharge.
    - Tearing makes eyelids stick.
    - Discharge causing eyelids to adhere.
    - Eyelids glued together by tears.
    - Sticky eyelids from eye discharge.

30. **Mucous discharge from the eye not causing eyelids to stick together**
    - Mucous discharge, but eyelids don't stick.
    - Eye producing mucous, lids remain separate.
    - Mucous present, but eyelids aren't glued.
    - Discharge is mucous, no sticking of lids.
    - Mucous from eye without sticky lids.

31. **Mild redness of the eye not accompanied by other symptoms**
    - Eye slightly red.
    - Mildly red eye.
- Slight redness.

32. **Photophobia if accompanied by redness and/or decrease in vision**
    - Light sensitivity with red, blurry eyes.
    - Photophobia with vision loss.
    - Eyes hurt in light, and blurry.
    - Photophobia with red eye.
    - Light bothers eyes, which are hazy.

33. **Photophobia as the only symptom**
    - Sensitivity to light without other symptoms.
    - Light bothers eyes without other issues.
    - Only symptom is light sensitivity.
    - Photophobia without redness or vision change.

34. **Chemical burns (alkali, acid, organic solvents)**
    - Eyes burned from alkali.
    - Acid exposure led to eye burns.
    - Suffered eye burns from substances.
    - Eyes injured by organic solvents.
    - Burns in eyes from a chemical agent.

35. **A foreign body in the eye or corneal abrasion caused by a foreign body**
    - Something stuck in eye.
    - Eye feels scratched by a foreign object.
    - Eye injured by something inside it.
    - Felt a scratch in the eye from debris.

36. **Trauma likely to disrupt or penetrate the globe (eye socket)**
    - Got hit in the eye with something sharp.
    - Eye trauma with risk of penetration.
    - A sharp object struck eye directly.

37. **Severe blunt trauma with visual complaints**
    - Hard hit to the eye, vision affected.
    - Blunt force to eye with sight issues.
    - Eye injury from a strong impact, vision troubles.
    - Severe eye hit, causing visual problems.
    - Blunt trauma leading to vision complaints.

38. **Blunt trauma not associated with vision loss or persistent pain**
    - Eye was hit but no lasting issues.
    - Trauma to the eye, no vision loss.
    - Blunt impact without ongoing pain.
    - Minor trauma, no vision or pain issues.

39. **Emergency referral from another physician**
    - Doctor sent urgently.
    - Immediate referral from another physician.

40. **Loss or breakage of glasses or contact lens needed for work, driving, or studies**
    - Glasses broke, affecting daily tasks.
    - Lost contacts, crucial for work.
    - Contacts lost, essential for studies.

41. **Sudden lid droop in one eye**
    - Eyelid started drooping unexpectedly.
    - One eyelid fell suddenly.
    - Experienced a sudden droop in one eye.
    - Eyelid sagged abruptly on one side.
    - Noticed eyelid drooping all of a sudden.

42. **Sudden change in pupil size**
    - One pupil suddenly changed size.
    - Pupil altered rapidly.
'''
generator_prompt = '''
    Your task: Create a detailed profile of a phone caller who's either a patient himself or someone calling on the patient's behalf, filling the format below:
        1.Caller Information
            Relationship to Patient:(self or other relationship)
            Age:
            Caller education level:
            Employment Status:
        2.Patient Demographics
            Full Name:
            Age:
            Gender:
            Race/Ethnicity:
            Education Level:
            Employment Status:
        3.Eye Condition Details
            main discomforts:
            Affects One Eye or Both:
            Duration:
            Onset:
            Associated symptoms:
            Triggers:
            Severity:
            Self-treatment:
        4.Previous Eye History
            Contact Lens/Glasses:
            Refractive Error:
            Previous Eye History:
        5.Medical History:
            Social and Occupational Impact:
        6.Caller Psychosocial Factors
            Health Literacy:
            Emotional State:
        7.Caller Response Style Indicators
            Response Completeness:
            Speech Style:
            Hesitation Markers:
    
Key Points:
1.Eye Condition and Previous Eye History should generate by randomly select one or multiple symptoms in the guideline. 
 2.The description of conditions should always be diverse and no need to be consistent with the text of guideline.
    {}
    The generated profile should be reasonable. Occupation needs to match education level.
'''.format(generator_guideline)

import pandas as pd
import re, os
df = pd.read_excel('add_time_filtered_reddit_info.xlsx')
# def filter_condition(row):
#     return isinstance(row['患者诉求'], float) or "症状分诊" in str(row['患者诉求'])

# url_pattern = re.compile(r'https?://\S+|www\.\S+')
# count = 0
# with open('profiles_reddit.txt', 'w', encoding='utf-8') as file:
#     for index, row in df.iterrows():
#         # print(index, row['患者诉求'])
#         if isinstance(row['患者诉求'], float) or "症状分诊" in row['患者诉求']:
#             profile = row['title']+'\n'+row['body']
#             profile = re.sub(url_pattern, '', profile)
#             file.write(profile+"\n##########\n")
#             count += 1
# print(count)

# filtered_df = df[df.apply(filter_condition, axis=1)]
# print(filtered_df.shape)
# output_file = r'filtered_reddit_info.xlsx'
# filtered_df.to_excel(output_file, index=False)

################## check accuracy
# answer = df['分诊分级'].tolist()
# pred = sorted(
#     os.listdir('reddit_qwen2.5-32b-instruct'),
#     key=lambda x: os.path.getmtime(os.path.join('reddit_qwen2.5-32b-instruct', x)),
#     reverse=False
# )
# # print(pred)
# pred = [p.split('_')[-1][:-4] for p in pred]
# # print(answer)
# correct = 0
# wrong = []
# for i in range(101):
#     if answer[i][0] == pred[i][0]: correct += 1
#     else: wrong.append(i)
# print(correct)
# print(wrong)
#qwen: [8, 10, 11, 12, 14, 15, 17, 19, 25, 26, 29, 32, 34, 36, 37, 38, 39, 41, 42, 47, 48, 53, 61, 65, 66, 67, 71, 72, 73, 74, 80, 82, 84, 88, 89, 91, 95, 96, 97, 100]

################# test API key
# from openai import OpenAI
# from dotenv import load_dotenv
# import os
# load_dotenv()
# print(os.getenv('OPENAI_BASE_URL'))
# # Way 1
# client = OpenAI()
# completion = client.chat.completions.create(
#   model="gpt-4o",
#   messages=[
#       {
#           "role": "user",
#           "content": "Hi"
#       }
#   ]
# )
# print(completion)
# Way 2
# from langchain_openai import ChatOpenAI
# llm = ChatOpenAI(model='gpt-4o', api_key="", base_url="")
# print(llm.invoke("Hi, who are you"))
# Way 3
# import requests
# import json
# 使用中转链接可以和特定的API可以不必向openai发起请求，且请求无须魔法
# 调用方式与openai官网一致，仅需修改baseurl
# Baseurl = "https://dashscope.aliyuncs.com/compatible-mode/v1"
# Skey = "sk-7eb36d090c544cf3a2c7c41bd4b06940"
# Baseurl = "https://api.claudeshop.top/v1/chat/completions"
# Skey = "sk-9c4sq7xhHnXZ8mthByarArw0gr478y6ENsPNLfORl4z8tzZP"
# payload = json.dumps({
#    "model": "gpt-4o",
#    "messages": [
#       {
#          "role": "system",
#          "content": "You are a helpful assistant."
#       },
#       {
#          "role": "user",
#          "content": "hello, who are you"
#       }
#    ]
# })
# headers = {
#    'Accept': 'application/json',
#    'Authorization': f'Bearer {Skey}',
#    'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
#    'Content-Type': 'application/json'
# }

# response = requests.request("POST", Baseurl, headers=headers, data=payload)
# data = response.json()
# print(data)